input {
        beats {
                port => 10515
                codec => plain { charset => "ISO-8859-1" }
        }
	tcp {
		port => 10514
                codec => plain { charset => "ISO-8859-1" }
	}
}
filter {
	grok {
		match   => [ "message", "%{SYSLOGBASE} %{GREEDYDATA:message}" ]
		overwrite => [ "message", "timestamp" ]
	}
	if "majesta.com.br" in [message] {
		mutate {
			add_field => [ "client", "majesta" ]
		}
	}
	else if "bananasantome.com.br" in [message] {
                mutate {
                        add_field => [ "client", "bananasantome" ]
                }
	}
        else if "distribuidoradnc.com.br" in [message] {
                mutate {
                        add_field => [ "client", "distribuidoradnc" ]
                }
        }
        date {
                timezone => "Etc/GMT+3"
                match => [ "timestamp", "MMM dd yyyy HH:mm:ss", "MMM  d yyyy HH:mm:ss", "MMM dd HH:mm:ss", "MMM  d HH:mm:ss" ]
        }
	if [program] == "postfix/cleanup" {
		dissect {
			mapping => [ "message", "%{amavis_postfix_queueid}: warning: header Subject: %{amavis_subject} from %{amavis_fromServer}[%{amavis_serverIp}]; from=<%{amavis_from}> to=<%{amavis_to}> proto=%{amavis_proto} helo=<%{amavis_helo}>" ]
		}
                if [tags] == "_dissectfailure" {
                        drop {}
                }
	}
	else if [program] == "postfix/postscreen" {
		dissect {
			mapping => [ "message", "%{amavis_postfix_queueid}: %{amavis_action}: RCPT from [%{amavis_relay_ip}]:%{amavis_relay_port}: %{amavis_category}; client [%{amavis_origin_ip}] blocked using %{amavis_blacklist}; from=<%{amavis_from}>, to=<%{amavis_to}>, proto=%{amavis_proto}, helo=<%{amavis_helo}>" ]
		}
		if [tags] == "_dissectfailure" {
			drop {}
		}
	}
	else if [program] == "amavis" {
        	grok {
			patterns_dir   => "/usr/share/logstash/config/patterns"
			match          => [ "message", "^%{AMAVIS}$" ]
			tag_on_failure => [ "_grok_amavis_nomatch" ]
			add_tag        => [ "_grok_amavis_success" ]
		}
		ruby {
			code => "event.set('rcpt', event.get('amavis_to_temp').split('@').count())
				event.set('amavis_rcpt', event.get('rcpt').to_i - 1)
				"
		}
		mutate {
			gsub => [
				"amavis_to_temp", ",<", ",amavis_to=",
				"amavis_to_temp", "<", "amavis_to=",
				"amavis_to_temp", ">", "",
				"amavis_from", "<", "",
				"amavis_from", ">", ""
			]
		}
		grok {
			patterns_dir   => "/usr/share/logstash/config/patterns"
			match          => [ "amavis_from", "^%{AMAVIS_FROM_USER_DOMAIN}$" ]
		}
		kv {
			field_split => ","
			source => "amavis_to_temp"
		}
		mutate {
			remove_field => ["amavis_to_temp"]
		}
		grok {
			patterns_dir   => "/usr/share/logstash/config/patterns"
			match          => [ "amavis_to", "^%{AMAVIS_TO_USER_DOMAIN}$" ]
		}
	} 
	if [amavis_postfix_queueid] and [amavis_helo] != "localhost" and [amavis_helo] != "127.0.0.1" {
	}
	else {
		drop {}
	}
	if [program] == "postfix/cleanup" {
		aggregate {
			task_id => "%{amavis_postfix_queueid}"
			code => "map['amavis_subject1'] ||= event.get('amavis_subject')"
			map_action => "create"
			timeout => 120    
		}
		drop {}	
	} else if [program] == "amavis" {
		aggregate {
			task_id => "%{amavis_postfix_queueid}"
			code => "event.set('amavis_subject', map['amavis_subject1'])"
			map_action => "update"
			end_of_task => true
		}
	}
	mutate {
		remove_field => ["message", "timestamp", "rcpt" ]
		rename => [ 	"amavis_action", "[email][action]",
				"amavis_category", "[email][category]",
				"amavis_from", "[source][user][email]",
				"amavis_to", "[destination][user][email]",
				"amavis_subject", "[email][subject]",
				"amavis_origin_ip", "[source][ip]",
				"amavis_match", "[email][match]",
				"amavis_size", "[email][bytes]",
				"amavis_rcpt", "[destination][recipients]",
				"amavis_elapsedtime", "[source][elapsedtime_ms]",
				"amavis_from_domain", "[source][domain]",
				"amavis_from_user", "[source][user][name]",
				"amavis_message-id", "[source][message_id]",
				"amavis_postfix_queueid", "[source][queue_id]",
				"amavis_relay_ip", "[destination][relay][ip]",
				"amavis_relay_port", "[destination][relay][port]",
				"amavis_to_domain", "[destination][domain]",
				"amavis_to_user", "[destination][user][name]",
				"amavis_hits", "[email][amavis_hits]",
				"amavis_id", "[email][amavis_id]",
				"amavis_match_originating", "[email][match_originating]",
				"amavis_blacklist","[email][blacklist]",
				"amavis_helo","[email][helo]",
				"amavis_proto","[email][proto]"
		]
	}
	geoip {
		source => "[source][ip]"
	}
}
output {
       if [destination][relay][ip] != "127.0.0.1" and "amazonaws.com" not in [host] {
		elasticsearch {
			hosts => ["elastic.capitallinux.com.br:9202"]
			index => "logstash-mail-%{+YYYY}"
			user => "elastic"
			password => "Bk@tech"
		}
                if "majesta" in [client] {
        	        elasticsearch {
	                        hosts => ["172.17.0.1:9201"]
                        	index => "majesta-mail"
                	        user => "elastic"
        	                password => "Bk@tech"
                                ilm_enabled => true
                                ilm_rollover_alias => "majesta-mail"
                                ilm_pattern => "{now/d}-000001"
                                ilm_policy => "mail"
	                }
		}
                else if "bananasantome" in [client] {
                        elasticsearch {
                                hosts => ["172.17.0.1:9201"]
                                index => "bananasantome-mail"
                                user => "elastic"
                                password => "Bk@tech"
                                ilm_enabled => true
                                ilm_rollover_alias => "bananasantome-mail"
                                ilm_pattern => "{now/d}-000001"
                                ilm_policy => "mail"
                        }
                }
                else if "distribuidoradnc" in [client] {
                        elasticsearch {
                                hosts => ["172.17.0.1:9201"]
                                index => "dnc-mail"
                                user => "elastic"
                                password => "Bk@tech"
                        	ilm_enabled => true
                	        ilm_rollover_alias => "dnc-mail"
        	                ilm_pattern => "{now/d}-000001"
	                        ilm_policy => "mail"
                        }
                }
                elasticsearch {
                        hosts => ["172.17.0.1:9201"]
                        index => "bktech-mail"
                        user => "elastic"
                        password => "Bk@tech"
			ilm_enabled => true
			ilm_rollover_alias => "bktech-mail"
			ilm_pattern => "{now/d}-000001"
			ilm_policy => "mail"
                }
	}
	else {
                elasticsearch {
                        hosts => ["elastic.capitallinux.com.br:9202"]
                        index => "logstash-capitalmail"
                        user => "elastic"
                        password => "Bk@tech"
                }

	}
}
